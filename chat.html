<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chat+</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:ital,opsz,wght@0,17..18,400..700;1,17..18,400..700&display=swap" rel="stylesheet">

    <style>
        /* --- [í…Œë§ˆ ë³€ìˆ˜] --- */
        :root {
            --bg-color: #ffffff;
            --surface-color: #f7f9fc;
            --primary-color: #3e81fe;
            --text-main: #2c3e50;
            --text-sub: #95a5a6;
            --error-color: #ff4757;
            --shadow-card: 0 4px 20px rgba(0,0,0,0.06);
            --radius-round: 30px; 
            --radius-card: 20px;
        }

        /* í°íŠ¸ ì ìš©: Google Sansë¥¼ ìµœìš°ì„ ìœ¼ë¡œ, í•œê¸€ì€ ì‹œìŠ¤í…œ/ê³ ë”• í°íŠ¸ë¡œ í´ë°± */
        * { 
            box-sizing: border-box; margin: 0; padding: 0; 
            font-family: 'Google Sans', 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', sans-serif; 
            -webkit-tap-highlight-color: transparent; user-select: none; 
        }
        body { background: var(--bg-color); height: 100vh; overflow: hidden; color: var(--text-main); }
        input, textarea { user-select: text; }

        /* --- [ì•„ì´ì½˜ & ìœ í‹¸] --- */
        .icon { width: 24px; height: 24px; fill: var(--text-main); }
        .icon-sm { width: 18px; height: 18px; fill: var(--text-main); }
        .icon-white { fill: white; }

        /* --- [ê³µí†µ UI] --- */
        .bubble-input {
            width: 100%; padding: 14px 20px; 
            border: 1px solid #e0e0e0; background: #f8f9fa;
            border-radius: var(--radius-round); font-size: 0.95rem; color: var(--text-main);
            outline: none; margin-bottom: 10px; transition: 0.2s;
        }
        .bubble-input:focus { border-color: var(--primary-color); background: #fff; }

        .bubble-btn {
            width: 100%; padding: 14px; border: none; border-radius: var(--radius-round);
            background: var(--primary-color); color: white; font-size: 1rem; font-weight: bold;
            cursor: pointer; position: relative; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            transition: background 0.2s;
        }
        .bubble-btn:active { opacity: 0.8; }
        .bubble-btn.secondary { background: #f0f2f5; color: var(--text-sub); }
        .bubble-btn:disabled { background: #e0e0e0; cursor: not-allowed; }

        .btn-content { transition: opacity 0.2s; }
        .loading-spinner {
            position: absolute; width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.3);
            border-top-color: #fff; border-radius: 50%;
            animation: spin 0.8s infinite linear; opacity: 0; transition: opacity 0.3s;
        }
        .bubble-btn.is-loading .btn-content { opacity: 0; }
        .bubble-btn.is-loading .loading-spinner { opacity: 1; }

        .error-msg { color: var(--error-color); font-size: 0.85rem; height: 20px; margin-bottom: 5px; text-align: center; }
        .toast-msg { color: var(--primary-color); font-size: 0.85rem; margin-top: 8px; text-align: center; display: none; }

        /* --- [í™”ë©´ ì „í™˜] --- */
        .view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); display: flex; flex-direction: column;
            opacity: 0; pointer-events: none; transform: scale(0.98);
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 0;
        }
        .view.active { opacity: 1; pointer-events: auto; transform: scale(1); z-index: 10; }

        .header {
            padding: 15px 20px; display: flex; align-items: center; justify-content: space-between;
            background: #fff; z-index: 20; border-bottom: 1px solid #f0f0f0;
        }
        .header h2 { font-size: 1.2rem; font-weight: 700; }
        .icon-btn { background: none; border: none; cursor: pointer; padding: 5px; display: flex; align-items: center; justify-content: center;}

        /* --- [ë¡œê·¸ì¸ & íšŒì›ê°€ì…] --- */
        .auth-container { flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 40px; }
        .app-logo { font-size: 2.5rem; font-weight: 900; color: var(--primary-color); margin-bottom: 30px; text-align: center; letter-spacing: -1px; }
        .link-text { text-align: center; margin-top: 20px; color: var(--text-sub); font-size: 0.85rem; text-decoration: underline; cursor: pointer; }
        
        /* ìë™ ë¡œê·¸ì¸ ì²´í¬ë°•ìŠ¤ UI */
        .auto-login-wrapper {
            display: flex; align-items: center; gap: 8px; margin-bottom: 20px; cursor: pointer; justify-content: center;
        }
        .auto-login-label { font-size: 0.9rem; color: #666; }
        
        .checkbox-custom {
            width: 22px; height: 22px; border: 2px solid #ddd; border-radius: 6px;
            display: flex; align-items: center; justify-content: center; transition: 0.2s; background: #fff;
        }
        .checkbox-custom svg { width: 14px; height: 14px; fill: white; display: none; }
        .checkbox-custom.checked { background: var(--primary-color); border-color: var(--primary-color); }
        .checkbox-custom.checked svg { display: block; }
        .checkbox-round { border-radius: 50%; }

        /* íšŒì›ê°€ì… ìŠ¬ë¼ì´ë” */
        .signup-wrapper { flex: 1; overflow: hidden; position: relative; display: flex; flex-direction: column; }
        .signup-slider { display: flex; width: 300%; height: 100%; transition: transform 0.4s ease; }
        .signup-step { width: 33.333%; flex-shrink: 0; padding: 40px; display: flex; flex-direction: column; justify-content: center; }
        .step-title { font-size: 1.8rem; font-weight: 800; margin-bottom: 10px; }
        .step-desc { color: var(--text-sub); margin-bottom: 30px; font-size: 0.95rem; }
        .terms-box { background: var(--surface-color); padding: 15px; border-radius: 15px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; cursor: pointer; }

        /* --- [ì¹œêµ¬ ëª©ë¡ (ì¹´ë“œí˜•)] --- */
        .list-container { flex: 1; overflow-y: auto; padding: 15px 20px; background: #fbfbfb; }
        .list-item {
            display: flex; align-items: center; padding: 16px; margin-bottom: 15px;
            background: #fff; border-radius: var(--radius-card); box-shadow: var(--shadow-card);
            cursor: pointer; transition: transform 0.2s; position: relative;
        }
        .list-item:active { transform: scale(0.97); background: #fafafa; }
        .avatar {
            width: 46px; height: 46px; border-radius: 18px; background: #dfe4ea;
            color: #777; font-weight: bold; display: flex; align-items: center; justify-content: center;
            font-size: 1.1rem; margin-right: 15px; flex-shrink: 0;
        }

        /* --- [ì•Œë¦¼ ì„¼í„°] --- */
        #view-notifications .list-container { background: #fff; }
        .noti-item { display: flex; flex-direction: column; padding: 15px; border-bottom: 1px solid #f0f0f0; gap: 10px; }
        .noti-actions { display: flex; gap: 8px; }
        .noti-actions button { flex: 1; padding: 10px; font-size: 0.9rem; }

        /* --- [ì±„íŒ…ë°©] --- */
        #view-chat .header { padding: 8px 15px; height: 50px; }
        #chat-title-area { display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 5px; border-radius: 8px;}
        #chat-title-area:active { background: #f0f0f0; }
        #chat-room-name { font-size: 1rem; font-weight: bold; }
        
        #chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #ffffff; }
        .msg-row { display: flex; width: 100%; align-items: flex-end; }
        .msg-row.received { justify-content: flex-start; }
        .msg-row.sent { justify-content: flex-end; }
        .msg { max-width: 75%; padding: 10px 16px; border-radius: 18px; font-size: 0.95rem; line-height: 1.4; word-break: break-word; }
        .msg.received { background: #f1f3f5; color: var(--text-main); border-bottom-left-radius: 4px; }
        .msg.sent { background: var(--primary-color); color: white; border-bottom-right-radius: 4px; }
        .msg-spinner { width: 14px; height: 14px; border: 2px solid #ddd; border-top-color: var(--primary-color); border-radius: 50%; margin-right: 8px; animation: spin 0.8s infinite linear; flex-shrink: 0; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .chat-input-area { padding: 8px 12px; background: #ffffff; border-top: 1px solid #eee; display: flex; gap: 8px; align-items: center; padding-bottom: max(8px, env(safe-area-inset-bottom)); }
        #msg-input { margin: 0; background: #f1f3f5; border: none; height: 42px; padding: 0 16px; flex: 1; }
        #send-btn { width: 42px; height: 42px; border-radius: 50%; flex-shrink: 0; padding: 0; display: flex; align-items: center; justify-content: center; }
        #send-btn svg { width: 20px; height: 20px; fill: white; }

        /* --- [ëª¨ë‹¬ & íŒì—…] --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 100; display: none;
            align-items: center; justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        .modal-box { width: 80%; max-width: 300px; background: white; padding: 25px; border-radius: 20px; text-align: center; }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .red-dot { position: absolute; top: 2px; right: 2px; width: 6px; height: 6px; background: #ff4757; border-radius: 50%; display: none; }

    </style>
</head>
<body>

<svg style="display:none;">
    <symbol id="icon-back" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></symbol>
    <symbol id="icon-search" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></symbol>
    <symbol id="icon-bell" viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></symbol>
    <symbol id="icon-arrow-up" viewBox="0 0 24 24"><path d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z"/></symbol>
    <symbol id="icon-check" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></symbol>
    <symbol id="icon-logout" viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></symbol>
    <symbol id="icon-edit" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></symbol>
</svg>

<div id="custom-modal" class="modal-overlay">
    <div class="modal-box">
        <h3 id="modal-title" style="margin-bottom: 10px;">ì•Œë¦¼</h3>
        <p id="modal-desc" style="color:#666; margin-bottom: 20px;">ë‚´ìš©</p>
        <button class="bubble-btn" onclick="closeModal()">í™•ì¸</button>
    </div>
</div>

<div id="logout-modal" class="modal-overlay">
    <div class="modal-box">
        <h3 style="margin-bottom: 10px;">ë¡œê·¸ì•„ì›ƒ</h3>
        <p style="color:#666; margin-bottom: 20px;">ì •ë§ ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>ìë™ ë¡œê·¸ì¸ë„ í•´ì œë©ë‹ˆë‹¤.</p>
        <div class="modal-btns">
            <button class="bubble-btn secondary" onclick="closeLogoutModal()">ì·¨ì†Œ</button>
            <button class="bubble-btn" onclick="confirmLogout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>
</div>

<div id="nickname-modal" class="modal-overlay">
    <div class="modal-box">
        <h3 style="margin-bottom: 5px;">ë³„ëª… ì„¤ì •</h3>
        <p style="color:#888; font-size:0.85rem; margin-bottom: 15px;">ë‚˜ì—ê²Œë§Œ ë³´ì´ëŠ” ì´ë¦„ì…ë‹ˆë‹¤.</p>
        <input type="text" id="nickname-input" class="bubble-input" placeholder="ë³„ëª… ì…ë ¥">
        <div class="modal-btns">
            <button class="bubble-btn secondary" onclick="closeNicknameModal()">ì·¨ì†Œ</button>
            <button class="bubble-btn" onclick="saveNickname()">ì €ì¥</button>
        </div>
    </div>
</div>

<div id="app">
    <div id="view-login" class="view active">
        <div class="auth-container">
            <div class="app-logo">Chat+</div>
            <input type="text" id="login-id" class="bubble-input" placeholder="ì•„ì´ë””" oninput="clearError('login-error')">
            <input type="password" id="login-pw" class="bubble-input" placeholder="ë¹„ë°€ë²ˆí˜¸" oninput="clearError('login-error')">
            
            <div class="auto-login-wrapper" onclick="toggleAutoLogin()">
                <div class="checkbox-custom" id="auto-login-check"><svg><use href="#icon-check"></use></svg></div>
                <span class="auto-login-label">ìë™ ë¡œê·¸ì¸</span>
            </div>

            <div id="login-error" class="error-msg"></div>
            <button id="btn-login" class="bubble-btn" onclick="tryLogin()">
                <span class="btn-content">ë¡œê·¸ì¸</span><div class="loading-spinner"></div>
            </button>
            <div class="link-text" onclick="startSignup()">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? íšŒì›ê°€ì…</div>
        </div>
    </div>

    <div id="view-signup" class="view">
        <div class="header" style="background:transparent; border:none;">
            <button class="icon-btn" onclick="cancelSignup()"><svg class="icon"><use href="#icon-back"></use></svg></button>
            <div style="width:24px;"></div>
        </div>
        <div class="signup-wrapper">
            <div class="signup-slider" id="signup-slider">
                <div class="signup-step">
                    <div class="step-title">ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹</div>
                    <div class="step-desc">ì‚¬ìš©í•˜ì‹¤ ì´ë¦„ê³¼ ì•„ì´ë””ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.</div>
                    <input type="text" id="signup-name" class="bubble-input" placeholder="ì´ë¦„ (ë‹‰ë„¤ì„)" oninput="clearError('signup-error-1')">
                    <input type="text" id="signup-id" class="bubble-input" placeholder="ì•„ì´ë”” (ê³µë°± ë¶ˆê°€)" oninput="clearError('signup-error-1')">
                    <div id="signup-error-1" class="error-msg"></div>
                    <button class="bubble-btn" onclick="nextSignupStep(2)">ë‹¤ìŒ</button>
                </div>
                <div class="signup-step">
                    <div class="step-title">ë³´ì•ˆ ì„¤ì • ğŸ”’</div>
                    <div class="step-desc">ì•ˆì „í•œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.</div>
                    <input type="password" id="signup-pw" class="bubble-input" placeholder="ë¹„ë°€ë²ˆí˜¸ (ê³µë°± ë¶ˆê°€)" oninput="clearError('signup-error-2')">
                    <input type="password" id="signup-pw-confirm" class="bubble-input" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" oninput="clearError('signup-error-2')">
                    <div id="signup-error-2" class="error-msg"></div>
                    <div style="display:flex; gap:10px;">
                        <button class="bubble-btn secondary" onclick="prevSignupStep()">ì´ì „</button>
                        <button class="bubble-btn" onclick="nextSignupStep(3)">ë‹¤ìŒ</button>
                    </div>
                </div>
                <div class="signup-step">
                    <div class="step-title">ì•½ê´€ ë™ì˜ âœ…</div>
                    <div class="step-desc">ë§ˆì§€ë§‰ ë‹¨ê³„ì…ë‹ˆë‹¤.</div>
                    <div class="terms-box" onclick="toggleTerms()">
                        <div class="checkbox-custom checkbox-round" id="terms-check"><svg><use href="#icon-check"></use></svg></div>
                        <span>ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€ì— ë™ì˜í•©ë‹ˆë‹¤.</span>
                    </div>
                    <div id="signup-error-3" class="error-msg"></div>
                    <div style="display:flex; gap:10px;">
                        <button class="bubble-btn secondary" onclick="prevSignupStep()">ì´ì „</button>
                        <button id="btn-signup-complete" class="bubble-btn" onclick="trySignup()">
                            <span class="btn-content">íšŒì›ê°€ì… ì™„ë£Œ</span><div class="loading-spinner"></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-friends" class="view">
        <div class="header">
            <h2 style="font-size: 1.4rem;">Friends</h2>
            <div style="display:flex; gap:4px;">
                <button class="icon-btn" onclick="switchView('view-search')">
                    <svg class="icon"><use href="#icon-search"></use></svg>
                </button>
                <button class="icon-btn" style="position:relative;" onclick="switchView('view-notifications'); checkNotifications();">
                    <svg class="icon"><use href="#icon-bell"></use></svg>
                    <div id="noti-badge" class="red-dot"></div>
                </button>
                <button class="icon-btn" onclick="openLogoutModal()" style="margin-left: 5px;">
                    <svg class="icon"><use href="#icon-logout"></use></svg>
                </button>
            </div>
        </div>
        <div style="padding: 20px 20px 0; background:#fbfbfb;">
            <h1 id="my-name-display" style="margin-bottom: 5px;">User</h1>
            <p style="color:#aaa; font-size:0.9rem;">ì¹œêµ¬ë¥¼ ê¸¸ê²Œ ëˆŒëŸ¬ ë³„ëª…ì„ ì„¤ì •í•´ë³´ì„¸ìš”.</p>
        </div>
        <div id="friend-list-ul" class="list-container"></div>
    </div>

    <div id="view-notifications" class="view">
        <div class="header">
            <button class="icon-btn" onclick="switchView('view-friends')">
                <svg class="icon"><use href="#icon-back"></use></svg>
            </button>
            <h2>ì•Œë¦¼</h2>
            <div style="width:24px;"></div>
        </div>
        <div id="noti-list" class="list-container"></div>
    </div>

    <div id="view-search" class="view">
        <div class="header">
            <button class="icon-btn" onclick="switchView('view-friends')">
                <svg class="icon"><use href="#icon-back"></use></svg>
            </button>
            <h2>ì¹œêµ¬ ì°¾ê¸°</h2>
            <div style="width:24px;"></div>
        </div>
        <div style="padding:20px;">
            <div style="display:flex; gap:10px;">
                <input type="text" id="search-input" class="bubble-input" placeholder="ì¹œêµ¬ ID ê²€ìƒ‰" style="margin:0;">
                <button class="bubble-btn" style="width:80px;" onclick="searchUser()">ê²€ìƒ‰</button>
            </div>
            <div id="search-result" style="margin-top:20px; display:none; background:#fff; padding:20px; border-radius:20px; box-shadow:var(--shadow-card);">
                <div style="margin-bottom:15px;">
                    <div id="result-name" style="font-weight:bold; font-size:1.1rem;"></div>
                    <div style="color:#888; font-size:0.9rem;">ì‚¬ìš©ì</div>
                </div>
                <button id="req-btn" class="bubble-btn" onclick="sendFriendRequest()">ì¹œêµ¬ ìš”ì²­ ë³´ë‚´ê¸°</button>
                <div id="req-toast" class="toast-msg">ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.</div>
            </div>
        </div>
    </div>

    <div id="view-chat" class="view">
        <div class="header">
            <button class="icon-btn" onclick="exitChat()">
                <svg class="icon"><use href="#icon-back"></use></svg>
            </button>
            <div id="chat-title-area" onclick="openNicknameModal(currentChatUser)">
                <h2 id="chat-room-name">Chat</h2>
                <svg class="icon-sm" style="fill:#aaa;"><use href="#icon-edit"></use></svg>
            </div>
            <div style="width:24px;"></div>
        </div>
        <main id="chat-messages"></main>
        <div class="chat-input-area">
            <input type="text" id="msg-input" class="bubble-input" placeholder="ë©”ì‹œì§€ ì…ë ¥">
            <button id="send-btn" class="bubble-btn" onclick="sendMessage()">
                <svg><use href="#icon-arrow-up"></use></svg>
            </button>
        </div>
    </div>
</div>

<script>
    const BASE_URL = "https://jaewondev5.pythonanywhere.com";

    let myId = null;
    let myName = null;
    let currentChatUser = null;
    let foundUser = null;
    let pollInterval = null;
    
    // íšŒì›ê°€ì… ê´€ë ¨
    let currentSignupStep = 1;
    let isTermsAgreed = false;
    
    // ìë™ë¡œê·¸ì¸ ê´€ë ¨
    let isAutoLoginChecked = false;

    // ë³„ëª… ì„¤ì • ê´€ë ¨
    let targetNicknameUser = null;
    let longPressTimer = null;

    // --- [ì´ˆê¸°í™”: ìë™ ë¡œê·¸ì¸ ì²´í¬] ---
    window.onload = function() {
        checkAutoLogin();
    };

    function checkAutoLogin() {
        const saved = localStorage.getItem('auto_login_info');
        if(saved) {
            const info = JSON.parse(saved);
            document.getElementById('login-id').value = info.id;
            document.getElementById('login-pw').value = info.pw;
            // ìë™ ë¡œê·¸ì¸ ì‹œë„
            tryLogin(true);
        }
    }

    // --- [ìœ í‹¸ë¦¬í‹°] ---
    function switchView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
    function toggleBtnLoading(btnId, isLoading) {
        const btn = document.getElementById(btnId);
        if(isLoading) { btn.disabled = true; btn.classList.add('is-loading'); } 
        else { btn.disabled = false; btn.classList.remove('is-loading'); }
    }
    function showError(elId, msg) { document.getElementById(elId).innerText = msg; }
    function clearError(elId) { document.getElementById(elId).innerText = ""; }
    function showModal(t, d) { document.getElementById('modal-title').innerText = t; document.getElementById('modal-desc').innerText = d; document.getElementById('custom-modal').classList.add('show'); }
    function closeModal() { document.getElementById('custom-modal').classList.remove('show'); }
    function hasSpace(s) { return /\s/.test(s); }

    // --- [ìë™ ë¡œê·¸ì¸ ë¡œì§] ---
    function toggleAutoLogin() {
        isAutoLoginChecked = !isAutoLoginChecked;
        const check = document.getElementById('auto-login-check');
        if(isAutoLoginChecked) check.classList.add('checked');
        else check.classList.remove('checked');
    }

    // --- [ë¡œê·¸ì•„ì›ƒ ë¡œì§] ---
    function openLogoutModal() { document.getElementById('logout-modal').classList.add('show'); }
    function closeLogoutModal() { document.getElementById('logout-modal').classList.remove('show'); }
    
    function confirmLogout() {
        // ë°ì´í„° ì´ˆê¸°í™”
        myId = null; myName = null; currentChatUser = null;
        if(pollInterval) clearInterval(pollInterval);
        
        // ìë™ ë¡œê·¸ì¸ ì •ë³´ ì‚­ì œ
        localStorage.removeItem('auto_login_info');
        
        // ë·° ì´ˆê¸°í™”
        document.getElementById('login-id').value = "";
        document.getElementById('login-pw').value = "";
        isAutoLoginChecked = false;
        document.getElementById('auto-login-check').classList.remove('checked');

        closeLogoutModal();
        switchView('view-login');
    }

    // --- [ë³„ëª…(Nickname) ë¡œì§] ---
    function getNickname(uid, originalName) {
        // ë‚´ ID ê¸°ë°˜ í‚¤ì—ì„œ ë³„ëª… ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        const key = `nicknames_${myId}`;
        const data = localStorage.getItem(key);
        if(data) {
            const json = JSON.parse(data);
            if(json[uid]) return json[uid]; // ì„¤ì •ëœ ë³„ëª… ë°˜í™˜
        }
        return originalName; // ì—†ìœ¼ë©´ ì›ë˜ ì´ë¦„
    }

    function openNicknameModal(uid) {
        targetNicknameUser = uid;
        document.getElementById('nickname-input').value = "";
        document.getElementById('nickname-modal').classList.add('show');
        // í˜„ì¬ ë³„ëª… ìˆìœ¼ë©´ í”„ë¦¬ì…‹
        const currentNick = getNickname(uid, "");
        if(currentNick) document.getElementById('nickname-input').value = currentNick;
    }
    function closeNicknameModal() { document.getElementById('nickname-modal').classList.remove('show'); targetNicknameUser = null; }

    function saveNickname() {
        if(!myId || !targetNicknameUser) return;
        const newNick = document.getElementById('nickname-input').value.trim();
        const key = `nicknames_${myId}`;
        let data = localStorage.getItem(key) ? JSON.parse(localStorage.getItem(key)) : {};
        
        if(newNick) {
            data[targetNicknameUser] = newNick;
        } else {
            delete data[targetNicknameUser]; // ë¹„ì–´ìˆìœ¼ë©´ ì‚­ì œ (ì›ë˜ ì´ë¦„ ì‚¬ìš©)
        }
        
        localStorage.setItem(key, JSON.stringify(data));
        closeNicknameModal();
        
        // UI ê°±ì‹ 
        loadFriends(); 
        if(currentChatUser === targetNicknameUser) {
            document.getElementById('chat-room-name').innerText = newNick || "Chat"; 
            if(!newNick) loadFriends(); 
            else document.getElementById('chat-room-name').innerText = newNick;
        }
    }

    // --- [íšŒì›ê°€ì…] ---
    function startSignup() {
        document.getElementById('signup-id').value = ''; document.getElementById('signup-name').value = '';
        document.getElementById('signup-pw').value = ''; document.getElementById('signup-pw-confirm').value = '';
        clearError('signup-error-1'); clearError('signup-error-2'); clearError('signup-error-3');
        isTermsAgreed = false; document.getElementById('terms-check').classList.remove('checked');
        currentSignupStep = 1; moveSignupSlider(1); switchView('view-signup');
    }
    function cancelSignup() { switchView('view-login'); }
    function moveSignupSlider(step) { document.getElementById('signup-slider').style.transform = `translateX(${-(step - 1) * 33.333}%)`; }
    function toggleTerms() { isTermsAgreed = !isTermsAgreed; document.getElementById('terms-check').classList.toggle('checked'); clearError('signup-error-3'); }

    function nextSignupStep(step) {
        if(step === 2) {
            const n = document.getElementById('signup-name').value.trim();
            const i = document.getElementById('signup-id').value;
            if(!n) return showError('signup-error-1', 'ì´ë¦„ ì…ë ¥');
            if(!i) return showError('signup-error-1', 'ì•„ì´ë”” ì…ë ¥');
            if(hasSpace(i)) return showError('signup-error-1', 'ì•„ì´ë”” ê³µë°± ë¶ˆê°€');
            clearError('signup-error-1');
        }
        if(step === 3) {
            const p = document.getElementById('signup-pw').value;
            const pc = document.getElementById('signup-pw-confirm').value;
            if(!p) return showError('signup-error-2', 'ë¹„ë°€ë²ˆí˜¸ ì…ë ¥');
            if(hasSpace(p)) return showError('signup-error-2', 'ë¹„ë°€ë²ˆí˜¸ ê³µë°± ë¶ˆê°€');
            if(p !== pc) return showError('signup-error-2', 'ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜');
            clearError('signup-error-2');
        }
        currentSignupStep = step; moveSignupSlider(step);
    }
    function prevSignupStep() { if(currentSignupStep > 1) { currentSignupStep--; moveSignupSlider(currentSignupStep); } }

    async function trySignup() {
        if(!isTermsAgreed) return showError('signup-error-3', 'ì•½ê´€ ë™ì˜ í•„ìš”');
        const id = document.getElementById('signup-id').value.trim();
        const pw = document.getElementById('signup-pw').value.trim();
        const name = document.getElementById('signup-name').value.trim();
        if(!id || !pw || !name) return showError('signup-error-3', 'ì •ë³´ í™•ì¸ í•„ìš”');

        toggleBtnLoading('btn-signup-complete', true);
        try {
            const res = await fetch(`${BASE_URL}/api/signup`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ user_id: id, password: pw, name: name })
            });
            toggleBtnLoading('btn-signup-complete', false);
            if(res.ok) { showModal("ì„±ê³µ", "íšŒì›ê°€ì… ì™„ë£Œ"); switchView('view-login'); }
            else { const d = await res.json(); showError('signup-error-3', d.detail || "ê°€ì… ì‹¤íŒ¨"); }
        } catch(e) { toggleBtnLoading('btn-signup-complete', false); showError('signup-error-3', "ì„œë²„ ì˜¤ë¥˜"); }
    }

    // --- [ë¡œê·¸ì¸] ---
    async function tryLogin(isAuto = false) {
        const id = document.getElementById('login-id').value.trim();
        const pw = document.getElementById('login-pw').value.trim();
        if(!id || !pw) return showError('login-error', 'ì•„ì´ë””/ë¹„ë²ˆ ì…ë ¥');

        toggleBtnLoading('btn-login', true);
        try {
            const res = await fetch(`${BASE_URL}/api/login`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ user_id: id, password: pw })
            });
            const d = await res.json();
            toggleBtnLoading('btn-login', false);
            if(res.ok) {
                myId = d.user_id; myName = d.name;
                document.getElementById('my-name-display').innerText = myName;
                clearError('login-error');
                
                // ìë™ ë¡œê·¸ì¸ ì €ì¥ ë¡œì§
                if(isAutoLoginChecked) {
                    localStorage.setItem('auto_login_info', JSON.stringify({ id: id, pw: pw }));
                }

                await loadFriends(); 
                startPolling(); 
                switchView('view-friends');
            } else {
                // ìë™ ë¡œê·¸ì¸ì´ ì‹¤íŒ¨í–ˆë‹¤ë©´ ì •ë³´ ì‚­ì œ
                if(isAuto) localStorage.removeItem('auto_login_info');
                showError('login-error', d.detail || "ë¡œê·¸ì¸ ì‹¤íŒ¨");
            }
        } catch(e) { 
            toggleBtnLoading('btn-login', false); 
            showError('login-error', "ì„œë²„ ì˜¤ë¥˜"); 
        }
    }

    // --- [ì¹œêµ¬ ëª©ë¡ (ì¹´ë“œí˜• + ë³„ëª… + ë¡±í”„ë ˆìŠ¤)] ---
    async function loadFriends() {
        try {
            const res = await fetch(`${BASE_URL}/api/friends/${myId}`);
            const list = await res.json();
            const container = document.getElementById('friend-list-ul');
            container.innerHTML = "";
            list.forEach(u => {
                const displayName = getNickname(u.user_id, u.name); // ë³„ëª… ì ìš©
                
                const div = document.createElement('div');
                div.className = 'list-item';
                
                // ë¡±í”„ë ˆìŠ¤ ì´ë²¤íŠ¸
                let pressTimer;
                const startPress = () => { pressTimer = setTimeout(() => openNicknameModal(u.user_id), 600); }
                const cancelPress = () => { clearTimeout(pressTimer); }
                
                div.addEventListener('mousedown', startPress);
                div.addEventListener('touchstart', startPress);
                div.addEventListener('mouseup', cancelPress);
                div.addEventListener('mouseleave', cancelPress);
                div.addEventListener('touchend', cancelPress);
                
                div.onclick = () => { cancelPress(); enterChat(u.user_id, displayName); };

                div.innerHTML = `
                    <div class="avatar">${displayName[0]}</div>
                    <div style="flex:1;">
                        <div style="font-weight:bold; font-size:1.05rem;">${displayName}</div>
                        <div style="font-size:0.85rem; color:#aaa; margin-top:4px;">í„°ì¹˜í•˜ì—¬ ëŒ€í™”í•˜ê¸°</div>
                    </div>`;
                container.appendChild(div);
            });
        } catch(e) {}
    }

    // --- [ê²€ìƒ‰ ë° ìš”ì²­] ---
    async function searchUser() {
        const q = document.getElementById('search-input').value;
        if(!q) return;
        document.getElementById('req-toast').style.display = 'none';
        try {
            const res = await fetch(`${BASE_URL}/api/search/${q}`);
            const d = await res.json();
            if(res.ok) {
                foundUser = d;
                document.getElementById('result-name').innerText = d.name;
                document.getElementById('search-result').style.display = 'block';
                const btn = document.getElementById('req-btn');
                btn.innerText = "ì¹œêµ¬ ìš”ì²­ ë³´ë‚´ê¸°"; btn.disabled = false;
            } else showModal("ì•Œë¦¼", "ì‚¬ìš©ì ì—†ìŒ");
        } catch(e) {}
    }

    async function sendFriendRequest() {
        if(!foundUser) return;
        try {
            const res = await fetch(`${BASE_URL}/api/friend/request`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ my_id: myId, target_id: foundUser.user_id })
            });
            const d = await res.json();
            if(d.status === 'ok' || res.ok) {
                const btn = document.getElementById('req-btn');
                btn.innerText = "ìš”ì²­ë¨"; btn.disabled = true;
                const toast = document.getElementById('req-toast');
                toast.innerText = d.message || "ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤."; toast.style.display = 'block';
            }
        } catch(e) {}
    }

    // --- [ì•Œë¦¼] ---
    async function checkNotifications() {
        try {
            const res = await fetch(`${BASE_URL}/api/notifications/${myId}`);
            const data = await res.json();
            const badge = document.getElementById('noti-badge');
            if(data.length > 0) { badge.style.display = 'block'; renderNotiList(data); } 
            else { badge.style.display = 'none'; document.getElementById('noti-list').innerHTML = "<div style='color:#ccc; text-align:center; padding:40px;'>ìƒˆë¡œìš´ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>"; }
        } catch(e) {}
    }

    function renderNotiList(data) {
        const list = document.getElementById('noti-list');
        list.innerHTML = "";
        data.forEach(n => {
            const div = document.createElement('div');
            div.className = 'noti-item';
            div.innerHTML = `
                <div style="font-size:0.95rem;"><b>${n.sender_name}</b>ë‹˜ì˜ ì¹œêµ¬ ìš”ì²­</div>
                <div class="noti-actions">
                    <button class="bubble-btn" onclick="respondFriend('${n.sender_id}', 'accept')">ìˆ˜ë½</button>
                    <button class="bubble-btn secondary" onclick="respondFriend('${n.sender_id}', 'reject')">ê±°ì ˆ</button>
                </div>`;
            list.appendChild(div);
        });
    }

    async function respondFriend(targetId, action) {
        try {
            await fetch(`${BASE_URL}/api/friend/respond`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ my_id: myId, target_id: targetId, action: action })
            });
            checkNotifications(); loadFriends();
        } catch(e) {}
    }

    // --- [ì±„íŒ…] ---
    function startPolling() {
        if(pollInterval) clearInterval(pollInterval);
        pollInterval = setInterval(() => {
            checkNotifications();
            if(currentChatUser) loadMessages(false);
        }, 2000);
    }

    function enterChat(fid, displayName) {
        currentChatUser = fid;
        document.getElementById('chat-room-name').innerText = displayName;
        document.getElementById('chat-messages').innerHTML = "";
        switchView('view-chat');
        loadMessages(true);
    }
    function exitChat() { currentChatUser = null; switchView('view-friends'); }

    function renderMessageRow(text, type, isTemp = false, tempId = null) {
        const container = document.getElementById('chat-messages');
        const row = document.createElement('div');
        row.className = `msg-row ${type}`;
        if(isTemp) row.id = `temp-row-${tempId}`;

        if(type === 'sent' && isTemp) {
            const spinner = document.createElement('div');
            spinner.className = 'msg-spinner';
            spinner.id = `spinner-${tempId}`;
            row.appendChild(spinner);
        }

        const msgDiv = document.createElement('div');
        msgDiv.className = `msg ${type}`;
        msgDiv.innerText = text;
        row.appendChild(msgDiv);
        
        container.appendChild(row);
        container.scrollTop = container.scrollHeight;
    }

    async function loadMessages(forceScroll) {
        if(!currentChatUser) return;
        try {
            const res = await fetch(`${BASE_URL}/api/messages?my_id=${myId}&other_id=${currentChatUser}`);
            const msgs = await res.json();
            
            const container = document.getElementById('chat-messages');
            const temps = Array.from(container.querySelectorAll('[id^="temp-row-"]'));
            container.innerHTML = "";
            
            msgs.forEach(m => {
                const type = m.sender === myId ? 'sent' : 'received';
                renderMessageRow(m.text, type);
            });
            
            temps.forEach(t => container.appendChild(t));

            if(forceScroll) container.scrollTop = container.scrollHeight;
        } catch(e) {}
    }

    async function sendMessage() {
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        if(!text) return;

        const tempId = Date.now();
        renderMessageRow(text, 'sent', true, tempId);
        input.value = "";

        try {
            await fetch(`${BASE_URL}/api/message/send`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ sender: myId, receiver: currentChatUser, text: text })
            });
            const spinner = document.getElementById(`spinner-${tempId}`);
            if(spinner) spinner.remove();
            const row = document.getElementById(`temp-row-${tempId}`);
            if(row) row.removeAttribute('id');
        } catch(e) { alert("ì „ì†¡ ì‹¤íŒ¨"); }
    }
    
    document.getElementById('msg-input').addEventListener('keypress', (e) => {
        if(e.key === 'Enter') sendMessage();
    });

</script>
</body>
</html>
