<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WordVoca</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-white: #ffffff;
            --text-dark: #1d1d1f;
            --text-gray: #86868b;
            --border-color: #f2f2f2;
            --input-bg: #f5f5f7;
            --accent-blue: #0071e3;
            --icon-blue: #0047AB; 
            --card-radius: 24px;
            
            --status-pink: #FF8CA1; 
            --status-vivid-blue: #40C4FF;
            --status-green: #34c759;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            outline: none;
            font-family: 'Google Sans', -apple-system, BlinkMacSystemFont, 'Pretendard', sans-serif;
        }

        body {
            background-color: var(--bg-white);
            color: var(--text-dark);
            margin: 0;
            padding: 70px 0 100px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: padding-top 0.3s ease;
        }

        body.friends-mode {
            padding-top: 0 !important;
            padding-bottom: 0 !important; 
            overflow: hidden !important; 
            height: 100vh; 
            width: 100%;
            position: fixed; 
        }

        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            transition: opacity 0.5s ease, visibility 0.5s;
        }
        .loader {
            width: 40px; height: 40px;
            border: 4px solid var(--input-bg);
            border-top: 4px solid var(--status-pink);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8); color: white;
            padding: 10px 20px; border-radius: 20px;
            font-size: 14px; font-weight: 500;
            z-index: 5000; opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease;
            white-space: nowrap;
        }
        .toast.show { opacity: 1; }

        .top-bar {
            position: fixed; top: 0; width: 100%; max-width: 600px;
            height: 60px; background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            display: flex; align-items: center; padding: 0 16px;
            border-bottom: 1px solid var(--border-color); z-index: 2000;
            gap: 12px;
            transition: transform 0.3s ease;
        }
        
        .top-bar.hide-bar {
            transform: translateY(-100%);
        }

        .top-logo {
            font-size: 18px; font-weight: 800; color: var(--text-dark);
            letter-spacing: -0.5px; margin-right: 4px; white-space: nowrap;
        }

        .search-container {
            flex: 1; height: 38px; background: var(--input-bg); 
            border-radius: 10px; display: flex; align-items: center; padding: 0 12px;
            overflow: hidden; 
        }

        .search-input {
            border: none; background: transparent; width: 100%;
            height: 100%; padding: 0; font-size: 15px; color: var(--text-dark);
            border-radius: 0; 
        }

        .top-btn {
            width: 38px; height: 38px; border-radius: 10px; 
            border: none; background: var(--input-bg);
            color: var(--text-dark); font-size: 22px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; transition: background 0.2s;
        }
        .top-btn:active { background: #e8e8ed; }
        
        #backBtn { display: none; }
        #exportBtnTop { display: none; font-size: 13px; font-weight: 500; width: auto; padding: 0 12px; }

        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; max-width: 600px;
            height: 80px; background: #ffffff; 
            display: flex; justify-content: space-around; align-items: flex-start;
            z-index: 2000;
            border-radius: 32px 32px 0 0; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.06); 
            padding-top: 15px;
            border: 1px solid rgba(0,0,0,0.02);
            border-bottom: none;
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .bottom-nav.hidden { transform: translateY(100%); }
        
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            cursor: pointer; color: #999; font-size: 11px; font-weight: 500;
            transition: color 0.2s; padding: 0 20px; gap: 6px;
        }
        .nav-item.active { color: var(--text-dark); }
        
        .nav-icon {
            width: 22px; height: 22px;
            background-color: #bbb;
            -webkit-mask-size: contain; mask-size: contain;
            -webkit-mask-repeat: no-repeat; mask-repeat: no-repeat;
            -webkit-mask-position: center; mask-position: center;
        }

        .nav-item.active .icon-voca { background-color: var(--icon-blue); }
        .nav-item.active .icon-friends, .nav-item.active .icon-settings { background-color: var(--text-dark); }

        @keyframes jelly-soft {
            0% { transform: scale(1); }
            30% { transform: scale(1.15); } 
            50% { transform: scale(0.95); } 
            70% { transform: scale(1.05); } 
            100% { transform: scale(1); }
        }
        
        .nav-item.animate .nav-icon {
            animation: jelly-soft 0.6s ease-in-out forwards;
        }

        .icon-voca {
            -webkit-mask-image: url('https://i.postimg.cc/T2c3nFjf/77eb49298ec7ee7107ca0d8cb98a507e-removebg-preview.png');
            mask-image: url('https://i.postimg.cc/T2c3nFjf/77eb49298ec7ee7107ca0d8cb98a507e-removebg-preview.png');
        }
        .icon-friends {
            -webkit-mask-image: url('https://i.postimg.cc/kGSthK3Y/user.png');
            mask-image: url('https://i.postimg.cc/kGSthK3Y/user.png');
        }
        .icon-settings {
             width: 22px; height: 22px;
             display: flex; flex-direction: column; justify-content: center; align-items: center; gap:4px;
             background: none !important; 
        }
        .icon-settings span {
            display: block; width: 18px; height: 2px; background-color: #bbb; border-radius: 2px; transition: background-color 0.2s;
        }
        .nav-item.active .icon-settings span { background-color: var(--text-dark); }

        .container { 
            width: 100%; max-width: 550px; padding: 16px; 
            transition: padding 0.3s;
        }
        
        .container.friends-mode {
            padding: 0; max-width: 100%; height: 100%; overflow: hidden;
        }

        .page { 
            display: none; opacity: 0; transform: translateY(10px); 
            transition: opacity 0.3s ease, transform 0.3s ease; 
        }
        .page.active { display: block; } 
        .page.show { opacity: 1; transform: translateY(0); }
        
        #tab-friends {
            position: fixed; top: 0; left: 0; width: 100%; bottom: 80px; 
            height: auto; z-index: 1000; background: white; padding: 0; margin: 0; overflow: hidden;
        }

        .chat-frame { width: 100%; height: 100%; border: none; display: block; overflow: hidden; }

        .card-book {
            background: white; padding: 20px; border-radius: var(--card-radius);
            border: 1px solid var(--border-color); margin-bottom: 12px; position: relative;
            box-shadow: 0 4px 16px rgba(0,0,0,0.02); transition: transform 0.2s, box-shadow 0.2s; cursor: pointer;
        }
        .card-book:active { transform: scale(0.98); box-shadow: 0 2px 8px rgba(0,0,0,0.02); }

        .book-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .book-tag { font-size: 11px; font-weight: 600; color: var(--text-gray); background: var(--input-bg); padding: 3px 8px; border-radius: 6px; }
        .book-menu-btn { background: none; border: none; font-size: 18px; color: var(--text-gray); padding: 4px; cursor: pointer; display: flex; align-items: center; }
        .book-title { font-size: 18px; font-weight: 700; color: var(--text-dark); margin: 0 0 16px 0; line-height: 1.3; }
        .book-footer { display: flex; justify-content: space-between; align-items: end; }
        .book-stats { display: flex; gap: 16px; align-items: center; }
        .stat-item { display: flex; align-items: center; gap: 6px; font-size: 14px; font-weight: 600; color: var(--text-gray); }
        .stat-item.blue { color: var(--accent-blue); }
        .stat-item.pink-text { color: var(--status-pink); } 
        
        .stat-icon { width: 16px; height: 16px; fill: currentColor; }
        .circle-chart { width: 42px; height: 42px; border-radius: 50%; position: relative; display: flex; align-items: center; justify-content: center; }
        .circle-inner { width: 34px; height: 34px; background: white; border-radius: 50%; position: absolute; display: flex; align-items: center; justify-content: center; }
        .circle-text { font-size: 10px; font-weight: 700; color: var(--text-dark); }

        .card-word {
            background: transparent; padding: 16px 8px; border-radius: 0; border: none;
            border-bottom: 1px solid var(--border-color); margin-bottom: 0; position: relative;
            box-shadow: none; transition: background-color 0.2s; padding-right: 50px; min-height: 80px;
            display: flex; flex-direction: column; justify-content: center;
        }
        
        .word-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
        .word-eng { font-weight: 700; font-size: 1.25rem; color: var(--text-dark); transition: opacity 0.2s; }
        .tts-btn { background: none; border: none; cursor: pointer; color: var(--text-gray); display: flex; align-items: center; padding: 4px; border-radius: 50%; }
        .tts-icon { width: 18px; height: 18px; fill: currentColor; }

        .word-kor { color: var(--text-gray); font-size: 0.95rem; line-height: 1.4; transition: opacity 0.2s; display: block; }

        .masked { background-color: #f0f0f5; color: transparent !important; border-radius: 6px; user-select: none; }
        .masked .tts-btn { visibility: hidden; }

        .word-edit-btn { position: absolute; bottom: 12px; right: 4px; background: none; border: none; color: var(--text-gray); padding: 6px; font-size: 12px; font-weight: 500; cursor: pointer; z-index: 10; }

        .status-check {
            position: absolute; top: 16px; right: 4px; width: 26px; height: 26px; cursor: pointer; 
            -webkit-mask-image: url('https://i.postimg.cc/MTW8GrjS/1000020262-removebg-preview.png');
            mask-image: url('https://i.postimg.cc/MTW8GrjS/1000020262-removebg-preview.png');
            -webkit-mask-size: contain; mask-size: contain; background-color: #d1d1d6;
        }
        .status-check.checked-1 { background-color: var(--status-pink); }
        .status-check.checked-2 { background-color: var(--status-vivid-blue); }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; display: none; flex-direction: column;
            z-index: 3000; padding: 24px; opacity: 0; transform: scale(0.95);
            transition: opacity 0.25s, transform 0.25s; overflow-y: auto;
        }
        .modal.open { opacity: 1; transform: scale(1); }

        .modal-header { display: flex; align-items: center; margin-bottom: 24px; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; font-size: 13px; margin-bottom: 8px; font-weight: 600; color: var(--text-gray); }
        .input-group input[type="text"] {
            width: 100%; padding: 14px; border-radius: 12px;
            border: 1px solid var(--border-color); font-size: 16px; background: var(--input-bg);
        }
        
        .meaning-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
        .meaning-row input { flex: 1; height: 48px; }

        .btn-remove { 
            width: 48px; height: 48px; border-radius: 12px; border: none; 
            background: #ffe5e5; color: #ff3b30; font-size: 20px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
        }

        .btn-full { width: 100%; padding: 16px; border-radius: 14px; border: none; background: var(--text-dark); color: white; font-weight: 600; margin-top: 10px; cursor: pointer; font-size: 15px; }
        .btn-sub { background: var(--input-bg); color: var(--text-dark); }
        .btn-add-meaning { width: 100%; padding: 12px; border-radius: 12px; border: 1px dashed var(--text-gray); background: white; color: var(--text-gray); margin-bottom: 10px; cursor: pointer; }
        .btn-find { background: transparent; color: var(--accent-blue); border: 1px solid var(--accent-blue); margin-top: 8px; }

        .fab-container { position: fixed; bottom: 40px; right: 20px; z-index: 2100; display: none; }
        .fab-btn { width: 44px; height: 44px; background: white; border-radius: 50%; box-shadow: 0 4px 14px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; font-size: 20px; }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 3500; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .overlay.active { opacity: 1; pointer-events: auto; }

        .bottom-sheet {
            position: fixed; bottom: 0; left: 0; right: 0; width: 100%;
            background: white; z-index: 4000; border-radius: 24px 24px 0 0;
            padding: 24px 24px 40px 24px; transform: translateY(120%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); max-width: 600px; margin: 0 auto;
        }
        .bottom-sheet.active { transform: translateY(0); }

        .sheet-header { font-size: 18px; font-weight: 700; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .sheet-section-title { font-size: 13px; font-weight: 600; color: var(--text-gray); margin-bottom: 12px; margin-top: 20px; }
        .chip-container { display: flex; gap: 10px; flex-wrap: wrap; }
        .chip { padding: 10px 16px; border-radius: 20px; background: var(--input-bg); border: none; font-size: 14px; font-weight: 500; cursor: pointer; }
        .chip.selected { background: var(--text-dark); color: white; }

        .menu-btn-sheet { background: var(--input-bg); border: none; padding: 16px; border-radius: 16px; font-size: 16px; font-weight: 600; text-align: left; cursor: pointer; margin-bottom: 12px; width: 100%; display: flex; justify-content: space-between; }
        .menu-btn-sheet.danger { color: #ff3b30; background: #ffe5e5; }

        .settings-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 60vh; text-align: center; }
        .app-name-large { font-size: 28px; font-weight: 800; color: var(--text-dark); margin-bottom: 8px; }
        .app-version { font-size: 14px; color: var(--text-gray); font-family: monospace; }
    </style>
</head>
<body>

    <div id="loadingOverlay"><div class="loader"></div></div>
    <div id="toast" class="toast">알림</div>

    <div class="top-bar">
        <button id="backBtn" class="top-btn" onclick="closeVocabDetail()">‹</button>
        <div class="top-logo" id="mainLogo">WordVoca</div>
        <div class="search-container">
            <input type="text" class="search-input" id="searchInput" placeholder="단어 검색" oninput="handleSearch()">
        </div>
        <button id="exportBtnTop" class="top-btn" onclick="openExportModal()">내보내기</button>
        <button id="addBtnTop" class="top-btn" onclick="handleTopPlus()">+</button>
    </div>

    <div class="container">
        <div id="tab-voca" class="page active show">
            <input type="file" id="fileInput" accept=".doc,.json,.txt" style="display:none" onchange="handleImport(event)">
            <div id="vocabList"></div>
        </div>
        <div id="voca-detail" class="page">
            <div id="wordContainer"></div>
        </div>
        <div id="tab-friends" class="page">
            <iframe id="chatIframe" class="chat-frame" scrolling="no"></iframe>
        </div>
        <div id="tab-settings" class="page">
            <div class="settings-container">
                <div class="app-name-large">WordVoca</div>
                <div class="app-version">Version 25.1.6.22</div>
                <div class="app-author">by shinjaewon</div>
            </div>
        </div>
    </div>

    <div id="fabContainer" class="fab-container">
        <button class="fab-btn" onclick="openViewSettings()">•••</button>
    </div>

    <div id="menuOverlay" class="overlay" onclick="closeAllBottomSheets()"></div>

    <div id="viewSettingsSheet" class="bottom-sheet">
        <div class="sheet-header"><span>보기 설정</span><button onclick="closeAllBottomSheets()" style="border:none; background:none; color:var(--accent-blue); font-weight:600;">완료</button></div>
        <div class="sheet-section-title">보기 필터</div>
        <div class="chip-container">
            <button class="chip selected" id="filter-all" onclick="toggleFilter('all')">전체</button>
            <button class="chip" id="filter-2" onclick="toggleFilter(2)">암기</button>
            <button class="chip" id="filter-1" onclick="toggleFilter(1)">미암기</button>
        </div>
        <div class="sheet-section-title">가리기 모드</div>
        <div class="chip-container">
            <button class="chip selected" id="mask-none" onclick="setMasking('none')">해제</button>
            <button class="chip" id="mask-word" onclick="setMasking('word')">단어 가리기</button>
            <button class="chip" id="mask-meaning" onclick="setMasking('meaning')">뜻 가리기</button>
        </div>
    </div>

    <div id="addMenuSheet" class="bottom-sheet">
        <div class="sheet-header"><span>추가하기</span><button onclick="closeAllBottomSheets()" style="border:none; background:none; color:var(--accent-blue); font-weight:600;">닫기</button></div>
        <button class="menu-btn-sheet" onclick="closeAllBottomSheets(); openVocabForm();">새 단어장 만들기</button>
        <button class="menu-btn-sheet" onclick="closeAllBottomSheets(); document.getElementById('fileInput').click();">파일 불러오기</button>
    </div>

    <div id="bookMenuSheet" class="bottom-sheet">
        <div class="sheet-header"><span id="bookMenuTitle">단어장 옵션</span><button onclick="closeAllBottomSheets()" style="border:none; background:none; color:var(--accent-blue); font-weight:600;">닫기</button></div>
        <button class="menu-btn-sheet" onclick="closeAllBottomSheets(); openVocabForm(contextVocabIdx);">이름 변경</button>
        <button class="menu-btn-sheet" onclick="closeAllBottomSheets(); openExportModal(contextVocabIdx);">내보내기 / 공유</button>
        <button class="menu-btn-sheet danger" onclick="closeAllBottomSheets(); deleteVocab(contextVocabIdx);">단어장 삭제</button>
    </div>

    <div id="exportSheet" class="bottom-sheet">
        <div class="sheet-header"><span>내보내기</span><button onclick="closeAllBottomSheets()" style="border:none; background:none; color:var(--accent-blue); font-weight:600;">취소</button></div>
        <button class="menu-btn-sheet" onclick="handleExportAction('share')">공유하기 / 링크 복사</button>
        <button class="menu-btn-sheet" onclick="handleExportAction('save')">파일로 저장</button>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('voca', this)"><div class="nav-icon icon-voca"></div><span>단어장</span></div>
        <div class="nav-item" onclick="switchTab('friends', this)"><div class="nav-icon icon-friends"></div><span>친구</span></div>
        <div class="nav-item" onclick="switchTab('settings', this)"><div class="icon-settings"><span></span><span></span><span></span></div><span>설정</span></div>
    </div>

    <div id="vocabForm" class="modal">
        <div class="modal-header"><h3>단어장 정보</h3></div>
        <div class="input-group"><label>이름</label><input type="text" id="v_name" placeholder="예: 토익 필수 영단어"></div>
        <button class="btn-full" onclick="saveVocab()">완료</button>
        <button class="btn-full btn-sub" onclick="closeModalWithAnim('vocabForm')">취소</button>
    </div>

    <div id="wordForm" class="modal">
        <div class="modal-header"><h3>단어 추가/수정</h3></div>
        <div class="input-group"><label>영어</label><input type="text" id="w_word" placeholder="영단어"><button class="btn-full btn-find" id="findBtn" onclick="fetchMeaning()">뜻 자동 완성 (Google)</button></div>
        <div class="input-group"><label>뜻</label><div id="meaningsContainer"></div><button class="btn-add-meaning" onclick="addMeaningInput()">+ 뜻 추가</button></div>
        <button class="btn-full" onclick="saveWord()">저장</button>
        <button class="btn-full btn-sub" id="delWordBtn" style="color:#ff3b30; display:none;" onclick="deleteWord()">삭제</button>
        <button class="btn-full btn-sub" onclick="closeModalWithAnim('wordForm')">취소</button>
    </div>

    <script>
        const icons = {
            list: '<svg viewBox="0 0 24 24" class="stat-icon"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>',
            paw: '<svg viewBox="0 0 24 24" class="stat-icon"><path d="M12 11.5c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5-1.5.67-1.5 1.5.67 1.5 1.5 1.5zm-5 0c.83 0 1.5-.67 1.5-1.5S7.83 8.5 7 8.5 5.5 9.17 5.5 10 6.17 11.5 7 11.5zm10 0c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5-1.5.67-1.5 1.5.67 1.5 1.5 1.5zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8 0-.57.06-1.13.17-1.67.65 1.25 1.95 2.17 3.48 2.17.43 0 .84-.08 1.22-.22.56.96 1.6 1.63 2.8 1.63 1.37 0 2.53-.87 2.97-2.06.42.27.91.43 1.44.43 1.54 0 2.8-.85 3.47-2.11.28.59.45 1.24.45 1.93 0 4.41-3.59 8-8 8z"/></svg>',
            menu: '<svg viewBox="0 0 24 24" width="20" height="20" fill="#86868b"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>',
            speaker: '<svg viewBox="0 0 24 24" class="tts-icon"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>'
        };

        let savedVocabs = JSON.parse(localStorage.getItem('myVocabs') || '[]');
        let currentVocabIdx = -1;
        let currentWordIdx = -1;
        let contextVocabIdx = -1;
        let isDetailView = false;
        let maskingMode = 'none'; 
        let activeFilters = new Set(['all']); 

        window.addEventListener('load', () => {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.opacity = '0';
            setTimeout(() => { overlay.style.display = 'none'; }, 500);
            renderList();
        });

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.classList.add('show');
            if(t.timer) clearTimeout(t.timer);
            t.timer = setTimeout(() => { t.classList.remove('show'); }, 2000);
        }

        function openModalWithAnim(id) {
            const el = document.getElementById(id);
            el.style.display = 'flex'; void el.offsetWidth; el.classList.add('open');
        }
        function closeModalWithAnim(id) {
            const el = document.getElementById(id);
            el.classList.remove('open'); setTimeout(() => { el.style.display = 'none'; }, 250); 
        }
        function switchPageWithAnim(hideId, showId) {
            const hideEl = document.getElementById(hideId);
            const showEl = document.getElementById(showId);
            hideEl.classList.remove('show');
            setTimeout(() => {
                hideEl.classList.remove('active');
                showEl.classList.add('active'); void showEl.offsetWidth; showEl.classList.add('show');
            }, 300);
        }

        function closeAllBottomSheets() {
            document.getElementById('menuOverlay').classList.remove('active');
            document.querySelectorAll('.bottom-sheet').forEach(sheet => sheet.classList.remove('active'));
        }

        function renderList() {
            const listDiv = document.getElementById('vocabList');
            listDiv.innerHTML = '';
            if (savedVocabs.length === 0) {
                listDiv.innerHTML = `<div style="text-align:center; color:var(--text-gray); margin-top:50px;"><p>단어장이 없습니다.<br>우측 상단 + 버튼을 눌러보세요.</p></div>`;
                return;
            }
            savedVocabs.forEach((v, idx) => {
                const total = v.corpusList.length;
                const memorized = v.corpusList.filter(w => w.status === 2).length;
                const percent = total === 0 ? 0 : Math.round((memorized / total) * 100);
                const chartStyle = `background: conic-gradient(var(--status-pink) 0% ${percent}%, #f0f0f5 ${percent}% 100%);`;

                const card = document.createElement('div');
                card.className = 'card-book';
                card.onclick = (e) => { if(!e.target.closest('.book-menu-btn')) openVocabDetail(idx); };
                card.innerHTML = `
                    <div class="book-header"><span class="book-tag">English / Korean</span><button class="book-menu-btn" onclick="openBookMenuSheet(${idx})">${icons.menu}</button></div>
                    <h3 class="book-title">${v.vocabulary.name}</h3>
                    <div class="book-footer">
                        <div class="book-stats">
                            <div class="stat-item blue">${icons.list} <span>${total}</span></div>
                            <div class="stat-item pink-text">${icons.paw} <span>${memorized}</span></div>
                        </div>
                        <div class="circle-chart" style="${chartStyle}"><div class="circle-inner"><span class="circle-text">${percent}%</span></div></div>
                    </div>
                `;
                listDiv.appendChild(card);
            });
        }

        // 불러오기 핵심 로직 수정
        function handleImport(event) {
            const file = event.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                const jsonMatch = content.match(/\{.*\}/s); // 파일 내 JSON 패턴 추출
                if(jsonMatch) {
                    try {
                        const data = JSON.parse(jsonMatch[0]);
                        // 유효성 검사: vocabulary와 corpusList가 있는지 확인
                        if(data.vocabulary && Array.isArray(data.corpusList)) {
                            // 상태(status) 정보가 없으면 0으로 초기화
                            data.corpusList = data.corpusList.map(item => ({
                                ...item,
                                status: item.status !== undefined ? item.status : 0
                            }));
                            savedVocabs.push(data);
                            saveAndRefresh();
                            showToast('단어장을 불러왔습니다.');
                        } else {
                            alert('올바른 단어장 형식이 아닙니다.');
                        }
                    } catch(err) {
                        alert('파일 읽기 오류: 형식이 잘못되었습니다.');
                    }
                } else {
                    alert('파일 내에서 데이터를 찾을 수 없습니다.');
                }
                event.target.value = ''; // 같은 파일 재선택 가능하게 초기화
            };
            reader.readAsText(file);
        }

        function saveAndRefresh(shouldRenderList = true) {
            localStorage.setItem('myVocabs', JSON.stringify(savedVocabs));
            if(shouldRenderList) renderList();
        }

        // --- 기타 UI 및 기능 함수들 ---
        function handleTopPlus() { if (isDetailView) openWordForm(); else openAddMenuSheet(); }
        function openVocabForm(idx = -1) { currentVocabIdx = idx; document.getElementById('v_name').value = idx > -1 ? savedVocabs[idx].vocabulary.name : ''; openModalWithAnim('vocabForm'); }
        function saveVocab() {
            const name = document.getElementById('v_name').value;
            if(!name) return;
            if(currentVocabIdx > -1) savedVocabs[currentVocabIdx].vocabulary.name = name;
            else savedVocabs.push({vocabulary:{name:name}, corpusList:[]});
            saveAndRefresh(); closeModalWithAnim('vocabForm');
        }
        function openAddMenuSheet() { document.getElementById('menuOverlay').classList.add('active'); document.getElementById('addMenuSheet').classList.add('active'); }
        function openBookMenuSheet(idx) { contextVocabIdx = idx; document.getElementById('bookMenuTitle').innerText = savedVocabs[idx].vocabulary.name; document.getElementById('menuOverlay').classList.add('active'); document.getElementById('bookMenuSheet').classList.add('active'); }
        function openExportModal(idx = -1) { if(idx > -1) contextVocabIdx = idx; else if(currentVocabIdx > -1) contextVocabIdx = currentVocabIdx; closeAllBottomSheets(); setTimeout(() => { document.getElementById('menuOverlay').classList.add('active'); document.getElementById('exportSheet').classList.add('active'); }, 100); }
        function deleteVocab(idx) { if(confirm('이 단어장을 삭제할까요?')) { savedVocabs.splice(idx, 1); saveAndRefresh(); } }
        
        function openVocabDetail(idx) {
            currentVocabIdx = idx; isDetailView = true; activeFilters.clear(); activeFilters.add('all'); maskingMode = 'none';
            switchPageWithAnim('tab-voca', 'voca-detail');
            document.getElementById('backBtn').style.display = 'flex';
            document.getElementById('exportBtnTop').style.display = 'flex';
            document.getElementById('fabContainer').style.display = 'flex';
            document.getElementById('mainLogo').style.display = 'none';
            document.querySelector('.bottom-nav').classList.add('hidden');
            renderWords();
        }

        function closeVocabDetail() {
            isDetailView = false; switchPageWithAnim('voca-detail', 'tab-voca');
            document.getElementById('backBtn').style.display = 'none';
            document.getElementById('exportBtnTop').style.display = 'none';
            document.getElementById('fabContainer').style.display = 'none';
            document.getElementById('mainLogo').style.display = 'block';
            document.querySelector('.bottom-nav').classList.remove('hidden');
            renderList();
        }

        function renderWords() {
            const container = document.getElementById('wordContainer');
            container.innerHTML = '';
            const v = savedVocabs[currentVocabIdx];
            const titleDiv = document.createElement('h2');
            titleDiv.style.margin = "0 0 16px 4px"; titleDiv.innerText = v.vocabulary.name;
            container.appendChild(titleDiv);

            v.corpusList.forEach((w, wIdx) => {
                const status = w.status || 0;
                if (!activeFilters.has('all') && !activeFilters.has(status)) return;
                let displayMeaning = Array.isArray(w.meaning) ? w.meaning.join(', ') : w.meaning;
                const wordClass = maskingMode === 'word' ? 'word-eng masked' : 'word-eng';
                const meanClass = maskingMode === 'meaning' ? 'word-kor masked' : 'word-kor';
                const card = document.createElement('div');
                card.className = 'card-word';
                card.innerHTML = `
                    <div onclick="toggleStatus(${wIdx}, this.nextElementSibling)">
                        <div class="word-row"><span class="${wordClass}">${w.word}</span><button class="tts-btn" onclick="speak('${w.word}'); event.stopPropagation();">${icons.speaker}</button></div>
                        <span class="${meanClass}">${displayMeaning}</span>
                    </div>
                    <div class="status-check checked-${status}" onclick="toggleStatus(${wIdx}, this)"></div>
                    <button class="word-edit-btn" onclick="openWordForm(${wIdx})">편집</button>
                `;
                container.appendChild(card);
            });
        }

        function toggleStatus(wIdx, divEl) {
            const v = savedVocabs[currentVocabIdx];
            let next = (v.corpusList[wIdx].status || 0) === 0 ? 2 : (v.corpusList[wIdx].status === 2 ? 1 : 0);
            v.corpusList[wIdx].status = next;
            saveAndRefresh(false); renderWords();
        }

        function speak(text) { if(!window.speechSynthesis) return; const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; window.speechSynthesis.speak(u); }

        function openWordForm(wIdx = -1) {
            currentWordIdx = wIdx; document.getElementById('delWordBtn').style.display = wIdx > -1 ? 'block' : 'none';
            const container = document.getElementById('meaningsContainer'); container.innerHTML = ''; 
            if(wIdx > -1) {
                const w = savedVocabs[currentVocabIdx].corpusList[wIdx];
                document.getElementById('w_word').value = w.word;
                let ms = Array.isArray(w.meaning) ? w.meaning : [w.meaning];
                ms.forEach(m => addMeaningInput(m));
            } else { document.getElementById('w_word').value = ''; addMeaningInput(); }
            openModalWithAnim('wordForm');
        }

        function addMeaningInput(val = '') {
            const container = document.getElementById('meaningsContainer');
            const div = document.createElement('div'); div.className = 'meaning-row';
            div.innerHTML = `<input type="text" class="meaning-input" placeholder="뜻" value="${val}"><button class="btn-remove" onclick="this.parentElement.remove()">-</button>`;
            container.appendChild(div);
        }

        async function fetchMeaning() {
            const word = document.getElementById('w_word').value; if(!word) return;
            document.getElementById('findBtn').innerText = '검색 중...';
            try {
                const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=ko&dt=t&q=${encodeURIComponent(word)}`);
                const data = await res.json();
                if(data[0][0][0]) {
                    document.getElementById('meaningsContainer').innerHTML = '';
                    addMeaningInput(data[0][0][0]);
                }
            } catch(e) { alert('검색 실패'); }
            document.getElementById('findBtn').innerText = '뜻 자동 완성 (Google)';
        }

        function saveWord() {
            const word = document.getElementById('w_word').value;
            const ms = []; document.querySelectorAll('.meaning-input').forEach(i => { if(i.value.trim()) ms.push(i.value.trim()); });
            if(!word || ms.length === 0) return;
            const obj = {word, meaning: ms, status: currentWordIdx > -1 ? savedVocabs[currentVocabIdx].corpusList[currentWordIdx].status : 0};
            if(currentWordIdx > -1) savedVocabs[currentVocabIdx].corpusList[currentWordIdx] = obj;
            else savedVocabs[currentVocabIdx].corpusList.push(obj);
            saveAndRefresh(false); renderWords(); closeModalWithAnim('wordForm');
        }

        function deleteWord() { savedVocabs[currentVocabIdx].corpusList.splice(currentWordIdx, 1); saveAndRefresh(false); renderWords(); closeModalWithAnim('wordForm'); }

        async function handleExportAction(type) {
            closeAllBottomSheets();
            const data = savedVocabs[contextVocabIdx];
            const content = JSON.stringify(data, null, 2);
            if (type === 'save') {
                const blob = new Blob([content], {type: 'text/plain'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `${data.vocabulary.name}.doc`; a.click();
            } else if (type === 'share') {
                try {
                    await navigator.share({ title: data.vocabulary.name, text: content });
                } catch (e) {
                    navigator.clipboard.writeText(content); alert('클립보드에 복사되었습니다.');
                }
            }
        }

        function switchTab(tab, el) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active', 'animate'));
            el.classList.add('active', 'animate');
            const target = 'tab-' + tab;
            const topBar = document.querySelector('.top-bar');
            const container = document.querySelector('.container');
            const iframe = document.getElementById('chatIframe');

            if (tab === 'friends') {
                topBar.classList.add('hide-bar'); document.body.classList.add('friends-mode'); container.classList.add('friends-mode');
                if(!iframe.src) iframe.src = "https://wordvoca.kro.kr/chat";
            } else {
                topBar.classList.remove('hide-bar'); document.body.classList.remove('friends-mode'); container.classList.remove('friends-mode');
            }
            if (isDetailView) closeVocabDetail();
            document.querySelectorAll('.page').forEach(p => { p.classList.remove('active', 'show'); if(p.id === target) p.classList.add('active', 'show'); });
        }

        function handleSearch() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            const selector = isDetailView ? '.card-word' : '.card-book';
            document.querySelectorAll(selector).forEach(el => { el.style.display = el.innerText.toLowerCase().includes(q) ? '' : 'none'; });
        }

        function toggleFilter(f) {
            if(f === 'all') { activeFilters.clear(); activeFilters.add('all'); }
            else { activeFilters.has('all') && activeFilters.delete('all'); activeFilters.has(f) ? activeFilters.delete(f) : activeFilters.add(f); if(activeFilters.size===0) activeFilters.add('all'); }
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
            activeFilters.forEach(v => { const e = document.getElementById('filter-'+v); if(e) e.classList.add('selected'); });
            renderWords();
        }

        function setMasking(m) {
            maskingMode = m; document.querySelectorAll('#mask-none, #mask-word, #mask-meaning').forEach(c => c.classList.remove('selected'));
            document.getElementById('mask-'+m).classList.add('selected'); renderWords();
        }

        function openViewSettings() { document.getElementById('menuOverlay').classList.add('active'); document.getElementById('viewSettingsSheet').classList.add('active'); }
    </script>
</body>
</html>
